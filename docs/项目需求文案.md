# TaskGo 项目需求文案

## 一、项目概述

TaskGo 是基于 Go 语言与 Gin 框架的轻量任务管理系统，采用 SQLite 作为存储，前端为无框架的原生 HTML/CSS/JavaScript，并集成 Tailwind 的 CDN 模式与 PWA 能力（Manifest + Service Worker）。系统提供完整的任务 CRUD、标签管理、收藏、评论、图片上传（含 WebP 转换）、API Token 管理等功能，支持桌面与移动端良好体验。

## 二、目标与定位

- 提供“开箱即用”的个人任务管理工具，部署与使用成本低。
- 优先保证移动端/PWA 的顺畅体验，适配 iOS/Android 浏览器与安装为独立应用的场景。
- 保持代码结构清晰、职责单一，易于扩展新功能。

## 三、系统架构

- 后端：Go + Gin；路由见 `internal/router/router.go:11-63`
- 数据库：SQLite（`internal/database/database.go`），通过 GORM 访问
- 认证：JWT（`internal/auth/auth.go`，`internal/middleware/auth_middleware.go`）
- 模型：`internal/models/*.go`，包含 `Task`、`Comment`、`ApiToken`、`User` 等
- 前端资源与模板：
  - 静态资源 `web/static`（CSS、JS、icons、config）
  - 模板页 `web/templates`（`index.html`、`settings.html`）
- PWA：`web/manifest.json`、`web/service-worker.js`

## 四、核心功能需求

1) 任务管理
- 创建/读取/更新/删除任务（后端路由：`/api/tasks` 系列，`internal/handlers/task_handler.go`）
- 任务内容支持标签（以逗号分隔），任务支持置顶、收藏、完成状态
- 任务展示按时间倒序，置顶优先；支持搜索与标签筛选（`web/static/js/script.js:1491-1560` 渲染逻辑）

2) 标签管理
- 左侧侧边栏展示所有唯一标签及计数（`renderTags`，`web/static/js/script.js:1187-1282`）
- 点击标签切换到该标签任务列表；再次点击取消筛选
- 标签右键菜单：编辑、删除（批量更新任务标签，`UpdateTagForAllTasks`）

3) 收藏与评论
- 收藏：任务支持 `favorite` 字段，筛选 Favorites 视图（`web/static/js/script.js`）
- 评论：任务下评论列表与新增（`/api/tasks/:id/comments`，`internal/handlers/task_handler.go`）

4) 图片上传
- 任务支持图片上传与删除（按用户归档目录），上传前尝试转为 WebP（前端 `convertImageToWebp`，`web/static/js/script.js:3289-3309`）

5) API Token 管理
- 列表、创建、更新、删除、硬删除（`/api/tokens` 系列，`internal/handlers/token_handler.go`）
- Token 支持名称与有效期（1 天/1 月/1 年/永久），更新或删除后旧值失效
- 设置页提供可视化管理（`web/templates/settings.html:172-271`）

6) 用户与认证
- 用户注册、登录、获取/更新信息（密码、头像）
- 所有受保护接口使用 JWT；前端将令牌存储于 `localStorage`

7) 搜索与输入交互
- 桌面与移动端搜索框，支持清除按钮；输入内容即时筛选
- 输入框支持快捷键与自动高度调整；标签自动完成（输入 `#` 触发，`web/static/js/script.js:2959-3010`）

8) PWA 能力
- 独立安装、缓存策略（静态资源/HTML/API 分别策略，`web/service-worker.js:101-238`）
- 在 `standalone` 模式下保持应用内导航；所有页面包含 PWA/Apple 元标签与 SW 注册

9) 设置页
- 主题模式（Light/Dark/System）
- 头像上传、密码更新
- 版本信息从 `web/static/config.json` 读取渲染
- API Tokens 可视化管理与复制剪贴板

## 五、交互与移动端细节

- 侧边栏：移动端点击标签后立即关闭侧边栏并筛选（`web/static/js/script.js:1187-1260` + `closeSidebarInstant:2401-2411`）
- 搜索框：移动与桌面保持占位一致，右侧清除按钮居中对齐
- 返回顶部按钮：可拖动，并记住最后位置（详见 `web/static/js/script.js`）
- PWA 内导航：所有内部链接使用同源路径；`settings.html` 增加 Apple 元标签与 SW 注册避免跳出浏览器

## 六、非功能性需求

- 性能：前端渲染与网络请求最小化；SW 缓存提升离线与弱网体验
- 安全：JWT 认证、后端鉴权中间件；不在前端日志中泄露敏感信息
- 可靠性：API 错误处理与前端反馈；操作结果刷新（例如 Token 更新后重新加载列表）

## 七、API 概要

- 认证：`POST /api/register`、`POST /api/login`、`GET /api/user`、`PUT /api/user/password`、`POST /api/user/avatar`
- 任务：`POST/GET /api/tasks`、`GET/PUT/DELETE /api/tasks/:id`、`POST /api/tasks/update-tags`
- 评论：`GET/POST /api/tasks/:id/comments`
- 图片：`POST/DELETE /api/tasks/:id/images`
- Token：`GET/POST /api/tokens`、`PUT/DELETE /api/tokens/:id`、`DELETE /api/tokens/:id/hard`

## 八、数据模型概要

- Task：`ID, content, tags, completed, favorite, pinned, CreatedAt, UpdatedAt`
- Comment：`ID, TaskID, content, author, CreatedAt`
- ApiToken：`ID, Token, Name, ExpiresAt, UserID, CreatedAt`
- User：`ID, username, password_hash, avatar_url`

## 九、PWA 行为与缓存策略

- API：网络优先，失败回退缓存
- 静态资源：缓存优先
- HTML：网络优先，失败提供离线页
- 版本更新：SW `updatefound` 时提示更新并支持 `SKIP_WAITING`

## 十、兼容性与边界

- 移动端 Safari/Chrome：输入法与安全区适配；`display-mode: standalone` 与 Apple 元标签保持一致
- 剪贴板：需 HTTPS 或用户交互触发
- 本地存储：令牌保存在 `localStorage`，注意跨域与隐私

## 十一、版本里程碑（参考）

- v0.3.x：完善移动端 UI、API Token 管理、图片 WebP 转换
- v0.2.x：PWA 完整支持、主题与交互优化
- v0.1.x：基础任务管理与标签/收藏/评论功能

## 十二、验收标准

- 任务/标签/收藏/评论/图片/Token 的端到端流程完整可用
- 移动端：侧边栏标签点击一次即关闭并筛选，Settings 在 PWA 内部打开
- 设置页：API Tokens 区域在窄屏下表单元素纵向堆叠、列表项按钮可换行